# Tauri 插件 Web Bluetooth

Tauri 2 桌面应用的原生 Web Bluetooth 适配器，底层基于 [`btleplug`](https://github.com/deviceplug/btleplug)。该插件尽可能复刻浏览器 Web Bluetooth API（设备发现、GATT 连接、服务/特征读取、通知以及可用性检测），这样你可以在桌面端复用既有的 Web Bluetooth 代码。

> ⚠️ 目前实现仅支持桌面平台（Windows、macOS、Linux）。除 `ping` 外的所有指令在移动端都会返回 `UnsupportedPlatform`。

## 安装

### 1. 添加 Rust 依赖

在 `src-tauri/Cargo.toml` 中加入依赖（或运行 `cargo add tauri-plugin-web-bluetooth`）：

```toml
[dependencies]
tauri-plugin-web-bluetooth = { path = "../tauri-plugin-web-bluetooth" }
```

在 `src-tauri/src/main.rs` 中初始化插件：

```rust
fn main() {
    tauri::Builder::default()
        .plugin(tauri_plugin_web_bluetooth::init())
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

#### 自定义设备选择器（桌面端）

默认情况下，`request_device` 会立即返回首个匹配的外设。桌面端可以通过向插件传入 [`SelectionHandler`](src/desktop.rs) 来接管选择逻辑。仓库自带的 `NativeDialogSelectionHandler` 会弹出一个与 Chromium 原生选择框风格相似的 Tauri 窗口：

```rust
use tauri_plugin_web_bluetooth::{
    init_with_selection_handler,
    desktop::{NativeDialogSelectionHandler, SelectionHandler},
};

fn main() {
    tauri::Builder::default()
        .plugin(init_with_selection_handler(SelectionHandler::new(
            NativeDialogSelectionHandler::new(),
        )))
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

若需要完全自定义的交互（例如只允许白名单设备、附加弹窗等），可以直接包装一个异步闭包：

```rust
use tauri_plugin_web_bluetooth::desktop::{DeviceSelectionContext, SelectionHandler};

let custom_handler = SelectionHandler::new(|ctx: DeviceSelectionContext<_>| {
    Box::pin(async move {
        let preferred = ctx
            .devices
            .iter()
            .find(|device| device.name.as_deref() == Some("My Sensor"))
            .map(|device| device.id.clone());
        Ok(preferred)
    })
});
```

当返回 `Ok(None)`（或使用内置对话框超时退出）时，前端会收到 `Error::SelectionCancelled` 以便告知用户操作被取消。

### 2. 使用 guest 端绑定

将 `guest-js` 目录链接或复制到前端项目中，然后按需导入帮助函数：

```ts
import {
    requestDevice,
    connectGATT,
    getPrimaryServices,
    getCharacteristics,
    startNotifications,
    onCharacteristicValueChanged,
} from '@/plugins/web-bluetooth'

const device = await requestDevice({ acceptAllDevices: true })
const gatt = await connectGATT(device.id)
const [service] = await getPrimaryServices(device.id)
const [characteristic] = await getCharacteristics(device.id, service.uuid)

await startNotifications(device.id, service.uuid, characteristic.uuid)
await onCharacteristicValueChanged(({ value }) => {
    const data = Uint8Array.from(atob(value), (char) => char.charCodeAt(0))
    console.log('notification payload', data)
})
```

所有包含原始字节的数据（读、写、通知）都会被编码为 Base64 字符串以适配 Tauri IPC。可使用 `atob`/`btoa`、`Buffer.from` 或任意 Base64 工具与 `Uint8Array` 互转。

## 可用指令

| 指令 | 说明 |
| --- | --- |
| `get_availability` | 返回主机是否检测到蓝牙适配器。
| `get_devices` | 列出通过 `request_device` 配对过的缓存设备。
| `request_device` | 根据 Web Bluetooth 过滤条件扫描，并由当前 `SelectionHandler` 决定返回哪个设备（默认仍是首个匹配）。
| `connect_gatt` / `disconnect_gatt` | 连接或断开设备主 GATT 服务器。
| `forget_device` | 移除某个缓存设备 ID。
| `get_primary_services` | 列出主服务（可按 UUID 过滤）。
| `get_characteristics` | 列出指定服务的特征。
| `read_characteristic_value` | 读取特征值（Base64 返回）。
| `write_characteristic_value` | 写入特征值（Base64 负载，可切换 `withResponse`）。
| `start_notifications` / `stop_notifications` | 订阅或取消订阅特征通知。

每条指令都受独立的权限控制（参见 `permissions/autogenerated/commands`）。默认权限集开放全部指令；在分发前请根据需要编辑 `permissions/default.toml` 以收紧权限。

## 事件

事件会通过 Tauri 事件系统广播到所有窗口。你可以使用 `guest-js` 中的辅助函数，也可以直接通过 `@tauri-apps/api/event` 监听。

| 事件 | 负载 |
| --- | --- |
| `web-bluetooth://characteristic-value-changed` | `{ deviceId, serviceUuid, characteristicUuid, value }`
| `web-bluetooth://gattserver-disconnected` | `{ deviceId }`

## 限制与路线图

- 目前仅支持桌面平台（btleplug 的移动后端仍属实验阶段）。
- `request_device` 的 UX 取决于应用传入的 `SelectionHandler`。如果需要更复杂的列表或多选，可以使用内置原生对话框或实现自定义 Handler。
- Descriptor API 以及广播监控（advertisement watching）尚未实现。

欢迎贡献！如果你发现实现与 Web Bluetooth 规范有差异，或遇到特定适配器的兼容性问题，请提交 Issue。